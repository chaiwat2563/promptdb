<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt Database App</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Kanit', sans-serif;
        }
        .prompt-title {
            font-family: 'Prompt', sans-serif;
            font-weight: 700;
        }
        .prompt-name {
            font-family: 'Prompt', sans-serif;
            font-weight: 600;
        }
        .loading {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .prompt-card { 
            min-height: 350px; 
            display: flex;
            flex-direction: column;
        }
        .prompt-text {
            max-height: 140px;
            overflow-y: auto;
            flex-grow: 1;
            word-wrap: break-word;
            word-break: break-word;
            hyphens: auto;
            line-height: 1.5;
            white-space: pre-wrap;
        }
        .prompt-text::-webkit-scrollbar {
            width: 4px;
        }
        .prompt-text::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 2px;
        }
        .prompt-text::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 2px;
        }
        .prompt-text::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        .card-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .card-footer {
            margin-top: auto;
            padding-top: 1rem;
        }
        .text-truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .expand-text {
            cursor: pointer;
            color: #4f46e5;
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }
        .expand-text:hover {
            text-decoration: underline;
        }
        .modal {
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-lg border-b-4 border-indigo-500">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-center">
                <i class="fas fa-robot text-4xl text-indigo-600 mr-4"></i>
                <div class="text-center">
                    <h1 class="prompt-title text-4xl text-gray-800">Prompt Database</h1>
                    <p class="text-sm text-gray-600 mt-1">จัดทำโดย ชัยวัฒน์ พรหมมา</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Controls -->
    <div class="container mx-auto px-4 py-6">
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <!-- Add Button -->
                <button onclick="openAddModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg flex items-center gap-2 transition-colors">
                    <i class="fas fa-plus"></i>
                    เพิ่ม Prompt
                </button>

                <!-- Search and Filters -->
                <div class="flex flex-wrap items-center gap-4">
                    <!-- Category Filter -->
                    <select id="categoryFilter" onchange="filterPrompts()" class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500">
                        <option value="">ทุกประเภท</option>
                    </select>

                    <!-- Search -->
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="ค้นหา..." onkeyup="filterPrompts()" class="border border-gray-300 rounded-lg px-4 py-2 pl-10 focus:ring-2 focus:ring-indigo-500">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>



                    <!-- Items per page -->
                    <select id="itemsPerPage" onchange="changeItemsPerPage()" class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500">
                        <option value="6">6 รายการ</option>
                        <option value="12">12 รายการ</option>
                        <option value="24">24 รายการ</option>
                        <option value="all">ทั้งหมด</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div id="loading" class="flex justify-center items-center py-12">
            <div class="loading"></div>
            <span class="ml-3 text-gray-600">กำลังโหลดข้อมูล...</span>
        </div>

        <!-- Prompts Grid -->
        <div id="promptsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6" style="display: none;"></div>

        <!-- Pagination -->
        <div id="pagination" class="flex justify-center items-center gap-2 mt-6" style="display: none;"></div>
    </div>

    <!-- Add/Edit Modal -->
    <div id="promptModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modalTitle" class="prompt-title text-2xl text-gray-800">เพิ่ม Prompt ใหม่</h2>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <form id="promptForm" onsubmit="savePrompt(event)">
                <input type="hidden" id="editId" value="">
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">ชื่อ Prompt</label>
                    <input type="text" id="promptName" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500">
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">ประเภท</label>
                    <input type="text" id="promptCategory" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500">
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Prompt</label>
                    <textarea id="promptText" required rows="6" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500"></textarea>
                </div>

                <div class="mb-6">
                    <label class="block text-gray-700 font-medium mb-2">รูปภาพ</label>
                    <input type="file" id="promptImage" accept="image/*" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500">
                    <div id="currentImage" class="mt-2" style="display: none;">
                        <img id="currentImagePreview" src="" alt="Current image" class="w-32 h-32 object-cover rounded-lg">
                    </div>
                </div>

                <div class="flex justify-end gap-3">
                    <button type="button" onclick="closeModal()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                        ยกเลิก
                    </button>
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg transition-colors">
                        <i class="fas fa-save mr-2"></i>
                        บันทึก
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50" style="display: none;" onclick="closeImageModal()">
        <div class="max-w-4xl max-h-[90vh] p-4">
            <img id="modalImage" src="" alt="Full size image" class="max-w-full max-h-full object-contain rounded-lg">
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxaDB6dhuljJxfgTsW2mHtS-vyF9Q9o4SEs0RoCSt5vVQp9YuYyWrZ3s52vAx7QCgWZ/exec';
        
        let allPrompts = [];
        let filteredPrompts = [];
        let currentPage = 1;
        let itemsPerPage = 6;


        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadPrompts();
        });

        // Load prompts from Google Sheets
        async function loadPrompts() {
            try {
                showLoading(true);
                const response = await fetch(`${SCRIPT_URL}?action=getPrompts`);
                const data = await response.json();
                
                if (data.success) {
                    allPrompts = data.data || [];
                    filteredPrompts = [...allPrompts];
                    updateCategoryFilter();
                    displayPrompts();
                } else {
                    throw new Error(data.error || 'Failed to load prompts');
                }
            } catch (error) {
                console.error('Error loading prompts:', error);
                Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถโหลดข้อมูลได้', 'error');
            } finally {
                showLoading(false);
            }
        }

        // Display prompts
        function displayPrompts() {
            const grid = document.getElementById('promptsGrid');
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = itemsPerPage === 'all' ? filteredPrompts.length : startIndex + parseInt(itemsPerPage);
            const pagePrompts = filteredPrompts.slice(startIndex, endIndex);

            if (pagePrompts.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center py-12 text-gray-500"><i class="fas fa-search text-4xl mb-4"></i><br>ไม่พบข้อมูลที่ค้นหา</div>';
            } else {
                grid.innerHTML = pagePrompts.map(prompt => createPromptCard(prompt)).join('');
            }

            updatePagination();
            grid.style.display = 'grid';
        }

        // Create prompt card
        function createPromptCard(prompt) {
            let imageHtml;
            if (prompt.ImageUrl) {
                const viewableUrl = convertToViewableUrl(prompt.ImageUrl);
                imageHtml = `<img src="${viewableUrl}" alt="${escapeHtml(prompt.ชื่อ || 'Prompt Image')}" class="w-full h-48 object-cover rounded-lg mb-4 cursor-pointer hover:opacity-90 transition-opacity" onclick="showImageModal('${escapeForJs(prompt.ImageUrl)}')" onerror="this.src=''; this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="w-full h-48 bg-gray-200 rounded-lg mb-4 items-center justify-center" style="display: none;">
                    <i class="fas fa-image text-gray-400 text-3xl"></i>
                    <p class="text-gray-500 text-sm mt-2">ไม่สามารถโหลดรูปได้</p>
                </div>`;
            } else {
                imageHtml = '<div class="w-full h-48 bg-gray-200 rounded-lg mb-4 flex items-center justify-center"><i class="fas fa-image text-gray-400 text-3xl"></i></div>';
            }

            // Process prompt text for display - handle very long text properly
            let promptText = '';
            let promptName = '';
            let promptCategory = '';
            
            // Safely handle potentially undefined or very long text
            try {
                promptText = (prompt.prompt || '').toString().trim();
                promptName = (prompt.ชื่อ || 'ไม่มีชื่อ').toString().trim();
                promptCategory = (prompt.ประเภท || 'ไม่ระบุ').toString().trim();
                
                // Limit extremely long text to prevent performance issues
                if (promptText.length > 10000) {
                    promptText = promptText.substring(0, 10000) + '... [ข้อความถูกตัดเนื่องจากยาวเกินไป]';
                }
                if (promptName.length > 200) {
                    promptName = promptName.substring(0, 200) + '...';
                }
                if (promptCategory.length > 100) {
                    promptCategory = promptCategory.substring(0, 100) + '...';
                }
            } catch (e) {
                console.error('Error processing prompt data:', e);
                promptText = 'เกิดข้อผิดพลาดในการแสดงข้อความ';
                promptName = 'ไม่สามารถแสดงชื่อได้';
                promptCategory = 'ไม่ระบุ';
            }
            
            const maxLength = 180;
            const isLongText = promptText.length > maxLength;
            const displayText = isLongText ? promptText.substring(0, maxLength) + '...' : promptText;
            const cardId = `card-${prompt.id || Math.random().toString(36).substr(2, 9)}`;

            // Format date safely
            let formattedDate = 'ไม่ระบุวันที่';
            try {
                if (prompt.creatDate) {
                    const date = new Date(prompt.creatDate);
                    if (!isNaN(date.getTime())) {
                        formattedDate = date.toLocaleDateString('th-TH');
                    }
                }
            } catch (e) {
                formattedDate = 'ไม่ระบุวันที่';
            }

            // Create safe escaped versions for HTML attributes
            const safePromptText = escapeForJs(promptText);
            const safePromptName = escapeForJs(promptName);
            const safeImageUrl = escapeForJs(prompt.ImageUrl || '');

            return `
                <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow prompt-card p-6">
                    ${imageHtml}
                    <div class="card-content">
                        <h3 class="prompt-name text-xl text-gray-800 mb-2 text-truncate" title="${escapeHtml(promptName)}">${escapeHtml(promptName)}</h3>
                        <div class="flex items-center gap-2 mb-3 flex-wrap">
                            <span class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm">
                                <i class="fas fa-tag mr-1"></i>${escapeHtml(promptCategory)}
                            </span>
                            <span class="text-gray-500 text-sm">
                                <i class="fas fa-calendar mr-1"></i>${formattedDate}
                            </span>
                        </div>
                        <div class="prompt-text bg-gray-50 p-3 rounded-lg mb-4 text-sm text-gray-700" id="${cardId}-text">
                            <div id="${cardId}-short" ${!isLongText ? 'style="display: block;"' : ''}>
                                ${escapeHtml(displayText)}
                                ${isLongText ? `<span class="expand-text" onclick="toggleText('${cardId}', true)">อ่านเพิ่มเติม</span>` : ''}
                            </div>
                            ${isLongText ? `
                            <div id="${cardId}-full" style="display: none;">
                                ${escapeHtml(promptText)}
                                <span class="expand-text" onclick="toggleText('${cardId}', false)">ย่อข้อความ</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="card-footer flex justify-between items-center">
                        <button onclick="copyPromptSafe('${cardId}', event)" data-prompt-text="${escapeHtml(promptText)}" data-prompt-name="${escapeHtml(promptName)}" class="text-green-600 hover:text-green-700 p-2 rounded-lg hover:bg-green-50 transition-colors" title="คัดลอก">
                            <i class="fas fa-copy"></i>
                        </button>
                        <div class="flex gap-2">
                            <button onclick="editPrompt(${prompt.id || 0})" class="text-blue-600 hover:text-blue-700 p-2 rounded-lg hover:bg-blue-50 transition-colors" title="แก้ไข">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deletePromptSafe(${prompt.id || 0}, '${cardId}')" class="text-red-600 hover:text-red-700 p-2 rounded-lg hover:bg-red-50 transition-colors" title="ลบ">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Update category filter
        function updateCategoryFilter() {
            const categoryFilter = document.getElementById('categoryFilter');
            const categories = [...new Set(allPrompts.map(p => p.ประเภท))].sort();
            
            categoryFilter.innerHTML = '<option value="">ทุกประเภท</option>' + 
                categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }

        // Filter prompts
        function filterPrompts() {
            try {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const categoryFilter = document.getElementById('categoryFilter').value;

                filteredPrompts = allPrompts.filter(prompt => {
                    try {
                        // Safely handle potentially undefined or very long text
                        const promptName = (prompt.ชื่อ || '').toString().toLowerCase();
                        const promptText = (prompt.prompt || '').toString().toLowerCase();
                        const promptCategory = (prompt.ประเภท || '').toString().toLowerCase();
                        
                        const matchesSearch = !searchTerm || 
                            promptName.includes(searchTerm) ||
                            promptText.includes(searchTerm) ||
                            promptCategory.includes(searchTerm);
                        
                        const matchesCategory = !categoryFilter || prompt.ประเภท === categoryFilter;
                        
                        return matchesSearch && matchesCategory;
                    } catch (e) {
                        console.error('Error filtering prompt:', e, prompt);
                        return false; // Exclude problematic prompts from results
                    }
                });

                currentPage = 1;
                displayPrompts();
            } catch (error) {
                console.error('Error in filterPrompts:', error);
                Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถกรองข้อมูลได้', 'error');
            }
        }



        // Change items per page
        function changeItemsPerPage() {
            itemsPerPage = document.getElementById('itemsPerPage').value;
            currentPage = 1;
            displayPrompts();
        }

        // Update pagination
        function updatePagination() {
            const pagination = document.getElementById('pagination');
            
            if (itemsPerPage === 'all' || filteredPrompts.length <= itemsPerPage) {
                pagination.style.display = 'none';
                return;
            }

            const totalPages = Math.ceil(filteredPrompts.length / itemsPerPage);
            let paginationHtml = '';

            // Previous button
            if (currentPage > 1) {
                paginationHtml += `<button onclick="changePage(${currentPage - 1})" class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"><i class="fas fa-chevron-left"></i></button>`;
            }

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage) {
                    paginationHtml += `<button class="px-3 py-2 bg-indigo-600 text-white rounded-lg">${i}</button>`;
                } else {
                    paginationHtml += `<button onclick="changePage(${i})" class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">${i}</button>`;
                }
            }

            // Next button
            if (currentPage < totalPages) {
                paginationHtml += `<button onclick="changePage(${currentPage + 1})" class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"><i class="fas fa-chevron-right"></i></button>`;
            }

            pagination.innerHTML = paginationHtml;
            pagination.style.display = 'flex';
        }

        // Change page
        function changePage(page) {
            currentPage = page;
            displayPrompts();
        }

        // Show/hide loading
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
            document.getElementById('promptsGrid').style.display = show ? 'none' : 'grid';
        }

        // Open add modal
        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'เพิ่ม Prompt ใหม่';
            document.getElementById('promptForm').reset();
            document.getElementById('editId').value = '';
            document.getElementById('currentImage').style.display = 'none';
            document.getElementById('promptModal').style.display = 'flex';
        }

        // Close modal
        function closeModal() {
            document.getElementById('promptModal').style.display = 'none';
        }

        // Save prompt
        async function savePrompt(event) {
            event.preventDefault();
            
            const formData = new FormData();
            const editId = document.getElementById('editId').value;
            
            formData.append('action', editId ? 'updatePrompt' : 'addPrompt');
            if (editId) formData.append('id', editId);
            formData.append('name', document.getElementById('promptName').value);
            formData.append('category', document.getElementById('promptCategory').value);
            formData.append('prompt', document.getElementById('promptText').value);
            
            const imageFile = document.getElementById('promptImage').files[0];
            if (imageFile) {
                formData.append('image', imageFile);
            }

            try {
                Swal.fire({
                    title: 'กำลังบันทึก...',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    Swal.fire('สำเร็จ!', editId ? 'แก้ไขข้อมูลเรียบร้อย' : 'เพิ่มข้อมูลเรียบร้อย', 'success');
                    closeModal();
                    loadPrompts();
                } else {
                    throw new Error(result.error || 'Failed to save prompt');
                }
            } catch (error) {
                console.error('Error saving prompt:', error);
                Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถบันทึกข้อมูลได้', 'error');
            }
        }

        // Edit prompt
        function editPrompt(id) {
            const prompt = allPrompts.find(p => p.id === id);
            if (!prompt) return;

            document.getElementById('modalTitle').textContent = 'แก้ไข Prompt';
            document.getElementById('editId').value = id;
            document.getElementById('promptName').value = prompt.ชื่อ;
            document.getElementById('promptCategory').value = prompt.ประเภท;
            document.getElementById('promptText').value = prompt.prompt;
            
            if (prompt.ImageUrl) {
                document.getElementById('currentImage').style.display = 'block';
                const viewableUrl = convertToViewableUrl(prompt.ImageUrl);
                document.getElementById('currentImagePreview').src = viewableUrl;
                document.getElementById('currentImagePreview').onerror = function() {
                    this.style.display = 'none';
                    this.parentElement.innerHTML = '<div class="w-32 h-32 bg-gray-200 rounded-lg flex items-center justify-center"><i class="fas fa-image text-gray-400"></i><br><span class="text-xs text-gray-500">ไม่สามารถโหลดรูปได้</span></div>';
                };
            } else {
                document.getElementById('currentImage').style.display = 'none';
            }

            document.getElementById('promptModal').style.display = 'flex';
        }

        // Delete prompt
        async function deletePrompt(id, name) {
            const result = await Swal.fire({
                title: 'ยืนยันการลบ',
                text: `คุณต้องการลบ "${name}" หรือไม่?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'ลบ',
                cancelButtonText: 'ยกเลิก'
            });

            if (result.isConfirmed) {
                try {
                    Swal.fire({
                        title: 'กำลังลบ...',
                        allowOutsideClick: false,
                        didOpen: () => Swal.showLoading()
                    });

                    const response = await fetch(`${SCRIPT_URL}?action=deletePrompt&id=${id}`);
                    const data = await response.json();

                    if (data.success) {
                        Swal.fire('ลบเรียบร้อย!', 'ข้อมูลถูกลบแล้ว', 'success');
                        loadPrompts();
                    } else {
                        throw new Error(data.error || 'Failed to delete prompt');
                    }
                } catch (error) {
                    console.error('Error deleting prompt:', error);
                    Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถลบข้อมูลได้', 'error');
                }
            }
        }

        // Copy prompt to clipboard - safe version with fallback
        async function copyPromptSafe(cardId, event) {
            try {
                let promptText = '';
                let promptName = '';
                
                // Try to get data from button attributes first (more reliable)
                if (event && event.target) {
                    const button = event.target.closest('button');
                    if (button) {
                        promptText = button.getAttribute('data-prompt-text') || '';
                        promptName = button.getAttribute('data-prompt-name') || '';
                    }
                }
                
                // Fallback to finding prompt by ID
                if (!promptText) {
                    const prompt = findPromptByCardId(cardId);
                    if (prompt) {
                        promptText = (prompt.prompt || '').toString();
                        promptName = (prompt.ชื่อ || 'ไม่มีชื่อ').toString();
                    }
                }
                
                if (!promptText || !promptText.trim()) {
                    throw new Error('ไม่มีข้อความให้คัดลอก');
                }
                
                // Try modern Clipboard API first
                if (navigator.clipboard && window.isSecureContext) {
                    try {
                        await navigator.clipboard.writeText(promptText);
                        showCopySuccess(promptName);
                        return;
                    } catch (clipboardError) {
                        console.warn('Clipboard API failed, trying fallback method:', clipboardError);
                    }
                }
                
                // Fallback method using textarea selection
                const success = copyTextFallback(promptText);
                if (success) {
                    showCopySuccess(promptName);
                } else {
                    throw new Error('ไม่สามารถคัดลอกได้ด้วยวิธีใดๆ');
                }
                
            } catch (error) {
                console.error('Error copying to clipboard:', error);
                // Show copy modal as last resort
                showCopyModal(promptText, promptName);
            }
        }

        // Fallback copy method using textarea selection
        function copyTextFallback(text) {
            try {
                // Create a temporary textarea element
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.left = '-999999px';
                textarea.style.top = '-999999px';
                document.body.appendChild(textarea);
                
                // Select and copy the text
                textarea.focus();
                textarea.select();
                textarea.setSelectionRange(0, textarea.value.length);
                
                const successful = document.execCommand('copy');
                document.body.removeChild(textarea);
                
                return successful;
            } catch (error) {
                console.error('Fallback copy method failed:', error);
                return false;
            }
        }

        // Show copy success message
        function showCopySuccess(promptName) {
            Swal.fire({
                title: 'คัดลอกเรียบร้อย!',
                text: `คัดลอก "${promptName.length > 50 ? promptName.substring(0, 50) + '...' : promptName}" แล้ว`,
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
        }

        // Show copy modal as last resort
        function showCopyModal(text, name) {
            Swal.fire({
                title: 'คัดลอกข้อความ',
                html: `
                    <p class="mb-4 text-gray-600">กรุณาเลือกข้อความด้านล่างและกด Ctrl+C (หรือ Cmd+C บน Mac) เพื่อคัดลอก</p>
                    <textarea id="copyTextArea" class="w-full h-40 p-3 border border-gray-300 rounded-lg text-sm" readonly>${text}</textarea>
                `,
                showCancelButton: true,
                confirmButtonText: 'เลือกทั้งหมด',
                cancelButtonText: 'ปิด',
                didOpen: () => {
                    const textarea = document.getElementById('copyTextArea');
                    textarea.focus();
                    textarea.select();
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const textarea = document.getElementById('copyTextArea');
                    textarea.select();
                    textarea.setSelectionRange(0, textarea.value.length);
                }
            });
        }

        // Copy prompt to clipboard - legacy version for backward compatibility
        async function copyPrompt(promptText, name) {
            try {
                await navigator.clipboard.writeText(promptText);
                Swal.fire({
                    title: 'คัดลอกเรียบร้อย!',
                    text: `คัดลอก "${name}" แล้ว`,
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });
            } catch (error) {
                console.error('Error copying to clipboard:', error);
                Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถคัดลอกได้', 'error');
            }
        }

        // Delete prompt - safe version
        async function deletePromptSafe(id, cardId) {
            try {
                const prompt = findPromptByCardId(cardId) || allPrompts.find(p => p.id === id);
                if (!prompt) {
                    Swal.fire('เกิดข้อผิดพลาด', 'ไม่พบข้อมูลที่ต้องการลบ', 'error');
                    return;
                }
                
                const promptName = (prompt.ชื่อ || 'ไม่มีชื่อ').toString();
                const displayName = promptName.length > 50 ? promptName.substring(0, 50) + '...' : promptName;
                
                const result = await Swal.fire({
                    title: 'ยืนยันการลบ',
                    text: `คุณต้องการลบ "${displayName}" หรือไม่?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'ลบ',
                    cancelButtonText: 'ยกเลิก'
                });

                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'กำลังลบ...',
                        allowOutsideClick: false,
                        didOpen: () => Swal.showLoading()
                    });

                    const response = await fetch(`${SCRIPT_URL}?action=deletePrompt&id=${id}`);
                    const data = await response.json();

                    if (data.success) {
                        Swal.fire('ลบเรียบร้อย!', 'ข้อมูลถูกลบแล้ว', 'success');
                        loadPrompts();
                    } else {
                        throw new Error(data.error || 'Failed to delete prompt');
                    }
                }
            } catch (error) {
                console.error('Error deleting prompt:', error);
                Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถลบข้อมูลได้', 'error');
            }
        }

        // Helper function to find prompt by card ID
        function findPromptByCardId(cardId) {
            try {
                // Extract ID from cardId (format: card-{id})
                const id = cardId.replace('card-', '');
                
                // Try to find by ID first
                let prompt = allPrompts.find(p => p.id && p.id.toString() === id);
                
                // If not found and ID looks like a number, try parsing
                if (!prompt && !isNaN(id)) {
                    prompt = allPrompts.find(p => p.id && p.id === parseInt(id));
                }
                
                // If still not found, try to find by index or other methods
                if (!prompt) {
                    console.warn('Prompt not found for cardId:', cardId, 'extracted id:', id);
                    console.log('Available prompts:', allPrompts.map(p => ({ id: p.id, name: p.ชื่อ })));
                }
                
                return prompt;
            } catch (error) {
                console.error('Error in findPromptByCardId:', error);
                return null;
            }
        }

        // Image URL utility functions
        function extractFileIdFromUrl(url) {
            if (!url) return null;
            
            // Handle different Google Drive URL formats
            const patterns = [
                /\/file\/d\/([a-zA-Z0-9-_]+)/,  // Standard Drive URLs
                /id=([a-zA-Z0-9-_]+)/,          // uc?id= format
                /\/d\/([a-zA-Z0-9-_]+)/,        // Short format
                /lh3\.googleusercontent\.com\/.*=s\d+-c/,  // lh3 format
                /lh5\.googleusercontent\.com\/.*=s\d+-c/   // lh5 format
            ];
            
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match && match[1]) {
                    return match[1];
                }
            }
            
            // Handle lh3/lh5 URLs - extract from the URL structure
            if (url.includes('lh3.googleusercontent.com') || url.includes('lh5.googleusercontent.com')) {
                // These are already processed Google URLs, try to find file ID in the path
                const pathMatch = url.match(/\/([a-zA-Z0-9-_]{25,})/);
                if (pathMatch && pathMatch[1]) {
                    return pathMatch[1];
                }
            }
            
            return null;
        }

        function convertToViewableUrl(url) {
            if (!url) return '';
            
            // If it's already a lh3/lh5 URL, return as is (these work for viewing)
            if (url.includes('lh3.googleusercontent.com') || url.includes('lh5.googleusercontent.com')) {
                return url;
            }
            
            // Extract file ID and convert to viewable format
            const fileId = extractFileIdFromUrl(url);
            if (fileId) {
                return `https://drive.google.com/uc?export=view&id=${fileId}`;
            }
            
            // If no file ID found, return original URL
            return url;
        }

        function isValidImageUrl(url) {
            if (!url) return false;
            
            // Check if it's a Google Drive URL (any format)
            const googleDrivePatterns = [
                /drive\.google\.com/,
                /lh3\.googleusercontent\.com/,
                /lh5\.googleusercontent\.com/,
                /googleusercontent\.com/
            ];
            
            return googleDrivePatterns.some(pattern => pattern.test(url));
        }

        // Show image modal
        function showImageModal(imageUrl) {
            const viewableUrl = convertToViewableUrl(imageUrl);
            document.getElementById('modalImage').src = viewableUrl;
            document.getElementById('imageModal').style.display = 'flex';
        }

        // Close image modal
        function closeImageModal() {
            document.getElementById('imageModal').style.display = 'none';
        }

        // Utility functions for text handling
        function escapeHtml(text) {
            if (!text) return '';
            try {
                // Convert to string and handle very long text
                let str = text.toString();
                
                // Limit extremely long strings to prevent browser performance issues
                if (str.length > 50000) {
                    str = str.substring(0, 50000) + '... [ข้อความถูกตัดเนื่องจากยาวเกินไป]';
                }
                
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            } catch (e) {
                console.error('Error in escapeHtml:', e);
                return 'เกิดข้อผิดพลาดในการแสดงข้อความ';
            }
        }

        function escapeForJs(text) {
            if (!text) return '';
            try {
                // Convert to string and handle special characters properly
                let str = text.toString();
                
                // Limit extremely long strings for JavaScript safety
                if (str.length > 10000) {
                    str = str.substring(0, 10000) + '... [ข้อความถูกตัดเนื่องจากยาวเกินไป]';
                }
                
                return str
                    .replace(/\\/g, '\\\\')
                    .replace(/'/g, "\\'")
                    .replace(/"/g, '\\"')
                    .replace(/\n/g, '\\n')
                    .replace(/\r/g, '\\r')
                    .replace(/\t/g, '\\t')
                    .replace(/\f/g, '\\f')
                    .replace(/\v/g, '\\v')
                    .replace(/\u0000/g, '\\u0000')
                    .replace(/\u0008/g, '\\u0008')
                    .replace(/\u000b/g, '\\u000b')
                    .replace(/\u000c/g, '\\u000c')
                    .replace(/\u000e/g, '\\u000e')
                    .replace(/\u000f/g, '\\u000f');
            } catch (e) {
                console.error('Error in escapeForJs:', e);
                return 'error';
            }
        }

        function toggleText(cardId, showFull) {
            const shortDiv = document.getElementById(`${cardId}-short`);
            const fullDiv = document.getElementById(`${cardId}-full`);
            
            if (showFull) {
                shortDiv.style.display = 'none';
                fullDiv.style.display = 'block';
            } else {
                shortDiv.style.display = 'block';
                fullDiv.style.display = 'none';
            }
        }

        // Close modals on escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
                closeImageModal();
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97cffe81a70afdc2',t:'MTc1NzUxODUxNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
